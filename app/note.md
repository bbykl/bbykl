# crm客户管理系统随手记
### 系统设计
#### 环境准备
1. 获取前端原型后，目录搞定
2. 关于项目中页面跳转路径
   首先，可以通过前端代码html超链接,其次通过script里window.location.herf也可以进行跳转。 
   在控制层中，可以通过请求转发和重定向来返回视图层。模板引擎thymleaf里也可以使用session和httpservletrequest.
   需要注意重定向/后需要加项目名 request.getContextPath.
   数据库表的对应实体类model以及默认mapper接口，和简单通用mapper.xml通过mybatis逆向工程创建。
   > 逆向工程首先配置maven依赖插件，然后进行数据库连接配置通过properties文件，然后配置逆向具体信息通过xml文件，设置一些依据表和生成实体类目录等
   > 具体信息看代码
3. 项目原型放在web-inf目录下，安全用户不能直接在浏览器地址栏进行访问。
4. 配置mvc，设置视图解析器（模板引擎）和视图控制。
5. 配置swagger接口文档（注意版本区别，还有spring.mvc.pathmatch.matching-strategy=ANT_PATH_MATCHER解决启动类不加EnableWebMvc注解失败），配置docket实例
#### 登录相关
1. 用户登陆成功或生成session信息，存取用户信息
2. 自定义返回状态信息封装，用于返回前端信息。
3. 可以自定义封装一些工具类，例如日期格式转换，以及一些常量标识，方便维护和复用。
4. 实现记住密码功能，前端input传参，验证登录成功后，response添加cookie保存到客户端，设置过期时间，以后每次访问登录页面判断是否存在相应cookie是则根据存取cookie名进行获取初始化为表单默认值。
5. 权限拦截，对控制层requestmappering进行拦截，放行登录接口，访问其他接口判断是否存在sesssion不存在则重定向登录页，否则放行。
6. 项目发布后，默认跳转首页然后进入登录页，可以进行判断，当设置session存在时直接跳转业务首页，否则跳转登录页。
7. 加入拦截器的流程，首先创建类实现HandlerInterceptor接口，然后进行相关业务逻辑设置，然后新建拦截器类实现webMvc接口，重写相应方法，最后在自定义webMvc配置类里注入该类。
8. 拦截器需要放行登录接口，否则会一直重定向。拦截/**路径代表该路径下所有子路径都被拦截而/*只拦截一层子目录。
9. 关于页面分割技术，可以通过div和iframe来使用。
10. cookie的使用，在同一个controller里可以获取cookie，但是在不同controller里可能获取不到cookie.

#### 市场活动部分
1. 模板窗口应用，通过js函数操作，添加固定类名。
2. requestMapping中/开头就代表协议加项目名。
3. 进入市场活动主页需要**动态获取用户信息**，可以在控制层通过request作用域或modelView视图返回给前端。
4. 创建市场活动，一般操作数据库，当进行查数据时一般不考虑异常信息，但当进行写数据时需要考虑异常。
5. 一般是通过js来控制模态窗口的显示与隐藏。
6. 对于字符集编码问题，在设置数据库的字符集编码后，表和字段的字符集也要进行改变。
7. 切记切记，对于id和一些属性不要加错标签上，比如createActivityBtn加在了span上，导致点击事件执行有问题。
8. 日期插件的使用，导入相关依赖，创建相关容器,调用封装函数，传递相关参数。
9. 数据库多表查询，可以和同一张表多次联查，还有就是where条件后不能用别名。
10. 分页查询，首先确定为异步请求，因为页面局部刷新，所以用ajax来处理，这里不能用thymleaf表达式了，因为thymleaf处理的是作用域里数据信息，这里是js获取的局部变量，需要主动获得标签值进行修改。
11. jquery.html()和append()的区别，一个是覆盖写，一个是追加写。js弱类型语言，函数形参不用写类型符号。
12. 分页功能实现，首先，结合条件查询，在页面初次加载进行请求发送，结合动态sql联表查询出所需要信息，返回前端首先市场活动列表，然后是总记录数。
13. 动态sql的模糊查询问题，可以用'%${}%'来使用，也可以用concat('%'+#{}+'%'),进行判断时，切记字段不要写错。
14. 对于插件（实现困难，业务不相关）的使用，首先导入相关依赖，css和script,然后创建容器，input或div,调用插件函数。
15. 分页的实现，只需要获取当前页号和每页大小，即可实现后端业务，其他上一页等细节功能借助插件实现。
16. jquery绑定事件函数，只能绑定固有元素（添加事件时，元素已经生成）。动态生成的元素（添加事件时，元素还没生成）
17. 异步请求，不用等待返回结果，代码继续执行。
18. jquery绑定事件,对于动态生成的元素通过$(间接或直接父元素需要是固有元素).on(evevt,目标选择器)。
19. 对于全选按钮功能实现，首先绑定事件，判断全选按钮状态，然后给每项进行赋值。给每个子项绑定事件，判断所有状态值进而控制全选按钮的状态。当切换页面时取消全选按钮的选中状态。
20. 在mapper.xml中，对于参数类型为数组时，类型写每个元素的数据类型。简单类型的返回值不用写。
21. 截取字符串函数，substr(startIndex,length),sunString(startIndex,endIndex);substr(startIndex)
22. ajax传送数据的三种方式，date:{},只支持一个key对应一个value情形，只支持字符串。date:"String",可以传递一个key对应多个value的情形。form-date,二进制传递
23. 当前端ajax传递date为字符串时，字符串名字需要和控制层参数对应。
24. 动态sql拼接 forEach标签，有separator和begin close,详情看activityMapper.xml文件。
25. mapper.xml文件里，自己写sql语句不要忘啦结果集映射（reslutMap）数据库字段和实体类不一致。
26. 自定义封装前端返回信息，对于错误信息的封装可以统一一下（returnObject.setCode(contants.RETURN_OBJECT_CODE_FAIL); 
    returnObject.setMessage("系统忙，请稍后再试");）这样不会让网站显得很low。
27. thymeleaf可以获得request请求里信息，${#httpServletRequest.getCookies()}或${#httpSession}
28. 关于参数封装为map还是实体类对象，一般查询sql用map，写数据用实体类对象（参数为实体类属性）。
29. 在控制层里，调用业务层方法，如果是读操作不用捕获异常，但是写操作需要捕获异常。
30. 前端获取参数进行封装时，对文本数据进行去空格 $.trim()
==导出市场活动==    
31. io操作适合没有格式的文件（图片，文本，音视频），不适合excel这种有格式的文件。
32. xls文件生成，借用插件apach.poi，五大类对象，hssfworkbook(文件对象)、hssfsheet(页)、hssfrow(行)、hssfcell(每行的单元格)、
    hssfcllstyle(单元格样式)，通过文件对象创建页，通过页创建行，继而创建单元格，设置单元格样式。创建输出流，关闭输出流，关闭文件对象。
33. 所有文件下载的请求都是同步请求。一般借助spingMvc控制层返回前端json信息或者视图解析的页面，但是对于文件的返回一般用response自己
    手动返回(控制层方法返回值为void)。response.setContentType("application/octet-stream;charset=utf-8"),octet-stream为二进制文件，通用写法当不知道文件类型时。
34. 文件下载功能，设置请求头的信息，一般浏览器打开通过显示窗口的方式直接打开响应信息，即使打不开也会借助应用程序。addHeader(Content-Disposition,attachment;filename="")打开下载窗口。
35. get方式和post方式提交表单，get方式参数有长度限制，因为浏览器对地址栏有长度限制。get方式对于服务器返回的静态资源会产生缓存，即下次访问这些不用再发起请求。而二进制参数传递会序列较长，所以用post方式进行文件上传功能实现。
36. 表单默认的编码格式为urlEncode,处理字符串类型(文本数据)的表单参数。所以后端接收参数信息都是字符串类型。当使用文件参数时（非字符串）需要修改编码方式
为enctype=multipart/form-data。
37. 文件上传功能实现
    - 首先导入插件 poi
    - 前端表单类型设置为multipart/from-date,收集参数判断是否为xls格式文件，判断大小是否合理，向后端发起请求（form-date对象）。需要获取文件对象发送给后端接口（通过dom对象获取）   
    - 借助form-date对象发送参数，模拟键值对表单数据，可以发送对象参数。平常请求参数只能字符串类型。
    - 利用插件解析文件获得hssfworkbook对象,继而获得相应行、单元格值，存储到实体类中，调用业务层通过dao层插入数据库里。
    - 后端将返回结果返回给前端，显示成功插入多少条数据，关闭模态窗口，页面刷新。插入失败则提示，模态窗口不关闭。
    - 注意发送ajax请求时因为不再是普通表单请求，所以应该取消默认转为字符串处理以及默认采用urlEncoding编码，通过processDate:false和contentType:false.
    ==注意事项==
      1. 首先ajax参数，请求方式为type而不是methods,其次数据参数为data而不是date。
